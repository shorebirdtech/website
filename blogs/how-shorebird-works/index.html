<!DOCTYPE html><html lang="en"> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><meta name="generator" content="Astro v4.5.12"><meta name="description" content="Explaining some of the changes we had to make to Dart and Flutter to make Shorebird's code push work."><meta property="og:description" content="Explaining some of the changes we had to make to Dart and Flutter to make Shorebird's code push work."><meta property="og:image" content="/open-graph.png"><meta property="og:url" content="https://shorebird.dev"><meta name="twitter:image" content="/open-graph.png"><meta name="twitter:card" content="summary_large_image"><link rel="canonical" href="https://shorebird.dev"><title>Blog | How Shorebird Works</title><link rel="stylesheet" href="/_astro/blog.DH1JIqNH.css">
<link rel="stylesheet" href="/_astro/blog.DJ8_mUfL.css">
<link rel="stylesheet" href="/_astro/1_0.j0eEi9un.css">
<style>html{font-family:Inter;background-color:#26272b;overflow-x:hidden;scroll-behavior:smooth}img{border-radius:10px}
</style></head> <body> <style>astro-island,astro-slot,astro-static-slot{display:contents}</style><script>(()=>{var e=async t=>{await(await t())()};(self.Astro||(self.Astro={})).load=e;window.dispatchEvent(new Event("astro:load"));})();;(()=>{var v=Object.defineProperty;var A=(c,s,a)=>s in c?v(c,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):c[s]=a;var d=(c,s,a)=>(A(c,typeof s!="symbol"?s+"":s,a),a);var u;{let c={0:t=>m(t),1:t=>a(t),2:t=>new RegExp(t),3:t=>new Date(t),4:t=>new Map(a(t)),5:t=>new Set(a(t)),6:t=>BigInt(t),7:t=>new URL(t),8:t=>new Uint8Array(t),9:t=>new Uint16Array(t),10:t=>new Uint32Array(t)},s=t=>{let[e,n]=t;return e in c?c[e](n):void 0},a=t=>t.map(s),m=t=>typeof t!="object"||t===null?t:Object.fromEntries(Object.entries(t).map(([e,n])=>[e,s(n)]));customElements.get("astro-island")||customElements.define("astro-island",(u=class extends HTMLElement{constructor(){super(...arguments);d(this,"Component");d(this,"hydrator");d(this,"hydrate",async()=>{var f;if(!this.hydrator||!this.isConnected)return;let e=(f=this.parentElement)==null?void 0:f.closest("astro-island[ssr]");if(e){e.addEventListener("astro:hydrate",this.hydrate,{once:!0});return}let n=this.querySelectorAll("astro-slot"),r={},l=this.querySelectorAll("template[data-astro-template]");for(let o of l){let i=o.closest(this.tagName);i!=null&&i.isSameNode(this)&&(r[o.getAttribute("data-astro-template")||"default"]=o.innerHTML,o.remove())}for(let o of n){let i=o.closest(this.tagName);i!=null&&i.isSameNode(this)&&(r[o.getAttribute("name")||"default"]=o.innerHTML)}let h;try{h=this.hasAttribute("props")?m(JSON.parse(this.getAttribute("props"))):{}}catch(o){let i=this.getAttribute("component-url")||"<unknown>",b=this.getAttribute("component-export");throw b&&(i+=` (export ${b})`),console.error(`[hydrate] Error parsing props for component ${i}`,this.getAttribute("props"),o),o}let p;await this.hydrator(this)(this.Component,h,r,{client:this.getAttribute("client")}),this.removeAttribute("ssr"),this.dispatchEvent(new CustomEvent("astro:hydrate"))});d(this,"unmount",()=>{this.isConnected||this.dispatchEvent(new CustomEvent("astro:unmount"))})}disconnectedCallback(){document.removeEventListener("astro:after-swap",this.unmount),document.addEventListener("astro:after-swap",this.unmount,{once:!0})}connectedCallback(){if(!this.hasAttribute("await-children")||document.readyState==="interactive"||document.readyState==="complete")this.childrenConnectedCallback();else{let e=()=>{document.removeEventListener("DOMContentLoaded",e),n.disconnect(),this.childrenConnectedCallback()},n=new MutationObserver(()=>{var r;((r=this.lastChild)==null?void 0:r.nodeType)===Node.COMMENT_NODE&&this.lastChild.nodeValue==="astro:end"&&(this.lastChild.remove(),e())});n.observe(this,{childList:!0}),document.addEventListener("DOMContentLoaded",e)}}async childrenConnectedCallback(){let e=this.getAttribute("before-hydration-url");e&&await import(e),this.start()}async start(){let e=JSON.parse(this.getAttribute("opts")),n=this.getAttribute("client");if(Astro[n]===void 0){window.addEventListener(`astro:${n}`,()=>this.start(),{once:!0});return}try{await Astro[n](async()=>{let r=this.getAttribute("renderer-url"),[l,{default:h}]=await Promise.all([import(this.getAttribute("component-url")),r?import(r):()=>()=>{}]),p=this.getAttribute("component-export")||"default";if(!p.includes("."))this.Component=l[p];else{this.Component=l;for(let y of p.split("."))this.Component=this.Component[y]}return this.hydrator=h,this.hydrate},e,this)}catch(r){console.error(`[astro-island] Error hydrating ${this.getAttribute("component-url")}`,r)}}attributeChangedCallback(){this.hydrate()}},d(u,"observedAttributes",["props"]),u))}})();</script><astro-island uid="5CUqm" prefix="r0" component-url="/_astro/Navbar.BXIy1FM_.js" component-export="Navbar" renderer-url="/_astro/client.Dx9pp6Fx.js" props="{&quot;links&quot;:[1,[[0,{&quot;label&quot;:[0,&quot;Pricing&quot;],&quot;href&quot;:[0,&quot;/#pricing&quot;],&quot;ariaLabel&quot;:[0,&quot;Pricing&quot;]}],[0,{&quot;label&quot;:[0,&quot;Team&quot;],&quot;href&quot;:[0,&quot;/#team&quot;],&quot;ariaLabel&quot;:[0,&quot;Team&quot;]}],[0,{&quot;label&quot;:[0,&quot;FAQ&quot;],&quot;href&quot;:[0,&quot;/#faq&quot;],&quot;ariaLabel&quot;:[0,&quot;FAQ&quot;]}],[0,{&quot;label&quot;:[0,&quot;Docs&quot;],&quot;href&quot;:[0,&quot;https://docs.shorebird.dev&quot;],&quot;ariaLabel&quot;:[0,&quot;Documentation&quot;]}],[0,{&quot;label&quot;:[0,&quot;Blog&quot;],&quot;href&quot;:[0,&quot;/blog&quot;],&quot;ariaLabel&quot;:[0,&quot;Blog&quot;]}]]]}" ssr="" client="load" opts="{&quot;name&quot;:&quot;Navbar&quot;,&quot;value&quot;:true}" await-children=""><nav class="fixed z-40 flex h-20 w-full flex-col items-center justify-center bg-shorebirdBg1 lg:bg-shorebirdBgTransparent lg:backdrop-blur-xl"><div class="relative flex w-11/12 items-center justify-between xl:w-10/12 2xl:w-[1280px]"><div style="opacity:0"><a class="navbar-link" href="/" aria-label="Home"><div class="flex grow basis-0 items-center justify-start"><div class="mr-2 text-6xl text-white"><svg width="32" height="27" viewBox="0 0 32 27" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.14266 7.36943C6.46801 1.61099 12.2836 0.0571273 15.0257 0L13.5975 1.8852C16.3396 1.94233 18.2248 4.7987 19.3102 6.79815C20.11 8.74048 25.0229 12.7965 27.0224 13.5963C29.0219 14.3961 30.7357 13.2535 31.4783 13.025C32.221 12.7965 31.9354 13.2535 31.9925 13.5963C32.0496 13.9391 31.0213 15.8243 29.6503 17.7095C28.2792 19.5947 24.6802 21.4227 23.5376 21.9369C22.3951 22.451 20.0529 22.8509 16.7395 22.7367C13.4261 22.6224 10.3412 20.7372 8.79881 19.5375C7.25637 18.3379 3.48596 14.5675 5.14266 7.36943Z" fill="url(#paint0_radial_532_20)"></path><path d="M15.4808 7.31245C16.7604 5.89569 18.5656 6.37937 19.3083 6.7983C19.632 7.12202 20.3823 7.91799 20.7936 8.51212C21.3078 9.25477 23.8214 11.0828 24.8497 11.5399C25.878 11.9969 26.9063 11.9398 27.4775 12.054C28.0488 12.1683 27.9917 12.3397 27.8774 12.8538C27.7632 13.3679 24.7354 15.0818 23.8214 15.5959C22.9074 16.1101 21.6506 16.9132 18.9084 16.5099C16.9661 16.2243 14.681 13.5965 14.1097 12.3397C13.5384 11.0828 13.8812 9.0834 15.4808 7.31245Z" fill="url(#paint1_linear_532_20)"></path><path d="M0 9.71136L5.14146 7.42627C5.00435 7.92899 4.93199 8.54977 4.91295 8.79733L0 9.71136Z" fill="#897F76"></path><circle cx="4.57031" cy="8.05468" r="0.114255" fill="#070707"></circle><ellipse cx="9.02535" cy="7.42598" rx="1.48531" ry="1.77095" fill="black"></ellipse><circle cx="9.02538" cy="6.68358" r="0.457019" fill="white"></circle><path d="M12.7978 25.2502H15.5971L16.8539 22.8508L17.9393 22.7937L16.7968 25.2502H17.9964C18.2821 25.2502 18.3963 25.5929 18.3963 25.8214C18.3963 26.0043 18.0916 26.2023 17.9393 26.2785H12.7978C12.5693 26.2785 12.5693 25.8786 12.5693 25.7072C12.5693 25.5701 12.7217 25.3454 12.7978 25.2502Z" fill="#AA937E"></path><path d="M14.7402 25.3071H17.5395L18.7963 22.9077L19.8817 22.8506L18.7391 25.3071H19.9388C20.2245 25.3071 20.3387 25.6498 20.3387 25.8783C20.3387 26.0611 20.034 26.2592 19.8817 26.3354H14.7402C14.5117 26.3354 14.5117 25.9355 14.5117 25.7641C14.5117 25.627 14.6641 25.4023 14.7402 25.3071Z" fill="#B19A84"></path><defs><radialGradient id="paint0_radial_532_20" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(21.5759 7.60491) rotate(131.66) scale(18.2956 32.4674)"><stop offset="0.0263478" stop-color="#897F75"></stop><stop offset="0.538541" stop-color="#DEDAD4"></stop><stop offset="0.86124" stop-color="#F2F4F3"></stop></radialGradient><linearGradient id="paint1_linear_532_20" x1="21.8791" y1="9.65467" x2="17.0804" y2="15.3674" gradientUnits="userSpaceOnUse"><stop stop-color="#AE9883"></stop><stop offset="1" stop-color="#A9927D"></stop></linearGradient></defs></svg></div><div class="font-[&#x27;Inter&#x27;] text-xl font-bold text-white">Shorebird</div></div></a></div><div style="opacity:0"><div class="hidden h-full pb-2 pl-12 lg:flex"><a class="navbar-link" href="/#pricing" aria-label="Pricing">Pricing</a><a class="navbar-link" href="/#team" aria-label="Team">Team</a><a class="navbar-link" href="/#faq" aria-label="FAQ">FAQ</a><a class="navbar-link" href="https://docs.shorebird.dev" aria-label="Documentation">Docs</a><a class="navbar-link" href="/blog" aria-label="Blog">Blog</a></div></div><div style="opacity:0"><div class="hidden grow basis-0 items-center justify-end lg:flex"><a class="flex rounded-xl
           bg-shorebirdBg2 text-sm text-white" href="https://discord.gg/shorebird" target="_blank" aria-label="discord"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 fill-white" viewBox="20 0 640 512"><path d="M524.531,69.836a1.5,1.5,0,0,0-.764-.7A485.065,485.065,0,0,0,404.081,32.03a1.816,1.816,0,0,0-1.923.91,337.461,337.461,0,0,0-14.9,30.6,447.848,447.848,0,0,0-134.426,0,309.541,309.541,0,0,0-15.135-30.6,1.89,1.89,0,0,0-1.924-.91A483.689,483.689,0,0,0,116.085,69.137a1.712,1.712,0,0,0-.788.676C39.068,183.651,18.186,294.69,28.43,404.354a2.016,2.016,0,0,0,.765,1.375A487.666,487.666,0,0,0,176.02,479.918a1.9,1.9,0,0,0,2.063-.676A348.2,348.2,0,0,0,208.12,430.4a1.86,1.86,0,0,0-1.019-2.588,321.173,321.173,0,0,1-45.868-21.853,1.885,1.885,0,0,1-.185-3.126c3.082-2.309,6.166-4.711,9.109-7.137a1.819,1.819,0,0,1,1.9-.256c96.229,43.917,200.41,43.917,295.5,0a1.812,1.812,0,0,1,1.924.233c2.944,2.426,6.027,4.851,9.132,7.16a1.884,1.884,0,0,1-.162,3.126,301.407,301.407,0,0,1-45.89,21.83,1.875,1.875,0,0,0-1,2.611,391.055,391.055,0,0,0,30.014,48.815,1.864,1.864,0,0,0,2.063.7A486.048,486.048,0,0,0,610.7,405.729a1.882,1.882,0,0,0,.765-1.352C623.729,277.594,590.933,167.465,524.531,69.836ZM222.491,337.58c-28.972,0-52.844-26.587-52.844-59.239S193.056,219.1,222.491,219.1c29.665,0,53.306,26.82,52.843,59.239C275.334,310.993,251.924,337.58,222.491,337.58Zm195.38,0c-28.971,0-52.843-26.587-52.843-59.239S388.437,219.1,417.871,219.1c29.667,0,53.307,26.82,52.844,59.239C470.715,310.993,447.538,337.58,417.871,337.58Z"></path></svg></a><a class="ml-4 flex
           rounded-xl bg-shorebirdBg2 text-sm text-white" href="https://twitter.com/shorebirddev" target="_blank" aria-label="twitter"><svg xmlns="http://www.w3.org/2000/svg" viewBox="10 0 512 512" class="h-6 w-6 fill-white"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a class="ml-4 flex
           rounded-xl bg-shorebirdBg2 text-sm text-white" href="https://github.com/shorebirdtech/shorebird" target="_blank" aria-label="source code"><svg xmlns="http://www.w3.org/2000/svg" viewBox="10 0 496 512" class="h-6 w-6 fill-white"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a><a class="ml-4 rounded-md border-2 border-slate-600 p-2 text-white hover:border-slate-400" href="https://console.shorebird.dev" target="_blank" aria-label="source code">Console</a></div></div><div class="flex cursor-pointer flex-col  rounded-md border border-solid border-gray-600 px-2 py-3 hover:bg-shorebirdBg2 lg:hidden"><div class="mb-1 h-0.5 w-5  bg-gray-500"></div><div class="mb-1 h-0.5 w-5  bg-gray-500"></div><div class="h-0.5 w-5 bg-gray-500 "></div></div></div></nav><!--astro:end--></astro-island> <div class="prose prose-invert mx-auto pt-24 pb-16 px-4 md:px-0"> <h1 id="how-shorebird-works">How Shorebird Works</h1>
<h2 id="code-push">Code push</h2>
<p>Code push, sometimes called “over the air updates”, is a way of updating
application code in production so that all your users are always running the
latest code – just like how a web application works. <a href="https://github.com/flutter/flutter/issues/14330">Code push for
Flutter</a> is one of the top 50
most upvoted issues across all of GitHub. Code push has long been used by mobile
developers to make app development more like web development.</p>
<p>Existing code push solutions have typically relied on WebViews or Lua scripts,
and require developers to use different languages and frameworks for different
parts of their applications. These also implicitly require developers to be able
to predict where their code will have bugs, since only some parts of their
applications are updatable and others not. At Shorebird, when we sat down to
build code push for Flutter, we wanted to build something better.</p>
<p>Shorebird’s code push for Flutter allows developers to update their Flutter apps
instantly, over the air, deploying fixes directly to end users’ devices.
Shorebird takes &#x3C; 5 minutes to integrate and requires no code changes. Our code
push can update any Dart code in your app. We’ve designed our system to comply
with Apple and Google store policies without sacrificing performance (even after
patching).</p>
<h2 id="how-does-code-push-work">How does code push work?</h2>
<p>Shorebird’s code push starts by forking Flutter &#x26; Dart. We’ve made very few
modifications to Flutter, but have made significant changes to Dart. Essentially
we built a custom Dart toolchain and Dart runtime to make apps updatable in
production.</p>
<p>Shorebird code push consists of:</p>
<ol>
<li>A command line program <code>shorebird</code> that knows how to wrap <code>flutter</code>,
including pulling down its own fork of Flutter’s engine.</li>
<li>A fork of Flutter’s engine that includes our custom updater, a library we
built to manage patches in your application.</li>
<li>A cloud service at shorebird.dev to store information about your releases
(builds you send to the stores) and patches (changes you make to releases via
Shorebird), control rollout, see analytics, etc.</li>
<li>And finally, a fork of the Dart compiler toolchain, which makes it possible
to construct and run these “patches” to your application.</li>
</ol>
<p>The command line and cloud service are already covered in our
<a href="https://docs.shorebird.dev/architecture/">architecture</a> documentation. But
recently we’ve received a bunch of questions about how our Dart modifications
work, so I’m going to cover those here.</p>
<h2 id="dart">Dart</h2>
<p>Dart has a “hot reload” feature used commonly during Flutter development. This
uses Dart’s “just-in-time” (JIT) compiler. A JIT compiler is a way of turning
source code into machine code right before the computer executes it. It’s the
way that JavaScript, Lua and many other languages typically work. Shorebird does
not use Dart’s JIT. Instead we use a custom interpreter we built. An
<a href="https://en.wikipedia.org/wiki/Interpreter_(computing)">interpreter</a> is code
that is used to execute logic from source code directly, without “compiling” it
(translating it to machine code). This is important in the context of updates,
because use of an interpreter is required by <a href="https://developer.apple.com/support/terms/apple-developer-program-license-agreement/#b331">Apple’s developer
agreement</a>
when updating applications. Dart did not have a production-ready interpreter,
but was designed in such a way that adding one was possible, so we did.</p>
<p>Just-in-time (JIT) systems have several nice properties. One is flexibility – a
JIT’d language like JavaScript can run source code it’s never seen before in
production. Another is that a JIT can be very good at “peak performance”, since
a JIT runtime includes a compiler during production, which means a sophisticated
JIT can run some code, measure that it’s being run very often and then go back
and compile the same code in a more optimized way (with different tradeoffs) to
make it run faster (a type of “profile guided optimization”). In an
ahead-of-time (AOT) compiled language (like Swift), the source code is only used
on the developer’s machine to produce the “machine code” which will end up
running on the user’s device. AOT solutions have the nice advantage of not
including a compiler in production (yields a smaller binary size) as well as
having faster startup because there is no work to do when starting the app. At
the tradeoff of some amount of peak performance as well as flexibility.</p>
<p>Dart is an atypical language in that it has both JIT and AOT compiler workflows.
Dart was designed originally as a JIT’d language, but is now most commonly used
(as part of Flutter) with an AOT workflow. <code>flutter run –debug</code> uses Dart’s JIT
mode, but <code>flutter build ipa</code> uses Dart’s AOT mode. Another side-effect of being
a JIT is that typically much more information about the source code is kept
around during production. This extra information is part of what enables a JIT
to optimize hot functions, it’s also exactly the kind of information that has
enabled what Shorebird has done.</p>
<p>Functions within a JIT runtime need to be aware they could have different
compiled representations (e.g. one simple compile and one later optimized
compile for the same function). Shorebird takes advantage of this quirk of
Dart’s architecture to insert a new interpreter as an alternative mechanism
for a function to use to execute. This allows us to effectively replace parts of
your application at runtime without needing to compile new code on the device.</p>
<h2 id="an-interpreter-for-dart">An interpreter for Dart</h2>
<p>Adding an interpreter to Dart was a challenge (working on compilers is hard, if
you like compilers, we’re <a href="https://shorebird.dev/jobs/">hiring</a>), and took us
most of the last year. We didn’t try to build a particularly fancy interpreter
for Dart (that had been attempted at Google multiple times before), but rather
built something very simple. One of the challenges this creates is that
interpreters (and particularly our simple one) are very slow. In our case, our
current (unoptimized) interpreter is about 100x slower than executing Dart AOT
code on a CPU. Thankfully, we had an insight early on that made us not have to
care about interpreter speed.</p>
<p>This insight is that we can run only changed Dart logic on the interpreter,
while continuing to run unchanged code on the CPU. Since the vast majority of
the performance-critical Dart code in a Flutter program is typically the Flutter
framework itself, essentially all of your application would end up running (at
full speed) on the CPU, and your program as a whole would show unchanged
performance. This was our bet. Other than being extremely hard to make work, it
paid off.</p>
<p>Determining what parts of your program we could run on the CPU vs. interpreter
was hard. To do this we invented a new phase of Dart compilation we called the
“linker”. The linker’s job is to analyze two (similar) Dart programs and find
the maximal similarity between them and then decide what would be necessary to
update in the first one in order to make it run like the second. We still have a
<a href="https://github.com/shorebirdtech/shorebird/issues/1892">couple missing
optimizations</a> in this
part of our system, but when it works well, developers see 99% of their code run
on the CPU (even for large changes). Teaching the linker how to figure this out
however required significant changes to Dart’s compiler toolchain.</p>
<h2 id="changes-to-darts-toolchain">Changes to Dart’s Toolchain</h2>
<p>We made many changes to Dart, including:</p>
<ol>
<li>Runtime changes to add our interpreter.</li>
<li>Compiler changes teach the Dart compiler how to compile a program maximally
similar to a previous version of the same program.</li>
<li>A new linker which can compare parts two versions of an app and decide if and
how they’ve changed.</li>
</ol>
<p>And much more — too many to go through here, but I’ll give one example of a
problem we recently solved.</p>
<h2 id="optimizing-darts-constant-pool">Optimizing Dart’s constant pool</h2>
<p>In programming languages it is typical to have “constants” which are variables
that don’t change at runtime. These are often pre-computed during compile time,
saved in a common space and shared throughout the program. E.g. if you have the
string “hello” in your program many times, most compilers will only allocate a
single string “hello” and share it throughout your program.</p>
<p>Dart implements this using something called the “Object Pool” (aka a constant
pool). In Dart’s JIT mode, each function ends up with its own Object Pool to
hold constant references used within that function (e.g. strings, integers).
Dart’s AOT combines all of these “Object Pools” into one global object pool and
updates all parts of your program accordingly to reference slots in this global
object pool. So why does this matter? This matters because when we’re trying to
update your program if the new version of your code uses new constants (a very
common occurrence), those new constants also need a slot in this pool. Worse is
that if we add this slot in the middle of the pool, all of the references into
the latter half of the pool would break. If we’re trying to end up running code
on the CPU, we have to be very careful never to change things that the
pre-compiled code makes reference to.</p>
<p>For example:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">void</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">print</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"a"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">print</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"z"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>The dart compiler would produce an object pool:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>0 : "a"</span></span>
<span class="line"><span>1 : "z"</span></span>
<span class="line"><span></span></span></code></pre>
<p>If we then change that to be:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span style="color:#F97583">void</span><span style="color:#B392F0"> main</span><span style="color:#E1E4E8">() {</span></span>
<span class="line"><span style="color:#B392F0">print</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"a"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">print</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"b"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#B392F0">print</span><span style="color:#E1E4E8">(</span><span style="color:#9ECBFF">"z"</span><span style="color:#E1E4E8">);</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span></code></pre>
<p>Dart object pool would be:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8; overflow-x: auto;" tabindex="0"><code><span class="line"><span>0: "a"</span></span>
<span class="line"><span>1: "b"</span></span>
<span class="line"><span>2: "z"</span></span>
<span class="line"><span></span></span></code></pre>
<p>Notice that that index for “z” has changed! That means that all parts of your
program that reference “z” are now changed and thus we can’t use the previously
compiled (fast) version of any functions which reference “z”, thus having to run
all logic which references “z” on the interpreter.</p>
<p>We solved this by teaching the Dart compiler how to construct order-dependent
structures (there are many of these) like the Object Pool in a stable ordered
fashion. Importantly we taught Dart that sometimes when it’s processing a
“patch”, it should assign these indices in the Object Pool (and similar data
structures) to be maximally similar to how they were assigned in the provided
“base” release.</p>
<p>As noted above, we had to make many more changes to Dart in order to make it
work well for code push, but those we’ll have to save for another article.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In conclusion, we made a lot of (difficult) changes to Dart, so you don’t have
to. Shorebird’s Flutter &#x26; Dart now supports code push – allowing you to push
fixes to your production Flutter apps instantly. Shorebird is a drop-in
replacement for flutter build and you can add code push to your app in only a
few minutes – with no code changes required. Shorebird is free to use for small
applications, with pricing that scales with your business needs.</p>
<p>Learn more at our website: <a href="https://shorebird.dev">https://shorebird.dev</a>. Most Shorebird source code is
open on GitHub: <a href="https://github.com/shorebirdtech/shorebird">https://github.com/shorebirdtech/shorebird</a>. If you ever have
questions, our entire team is on Discord:
<a href="https://discord.gg/shorebird">https://discord.gg/shorebird</a>.</p> </div> <astro-island uid="hGIXx" prefix="r1" component-url="/_astro/Footer.1VnjrRUE.js" component-export="Footer" renderer-url="/_astro/client.Dx9pp6Fx.js" props="{}" ssr="" client="load" opts="{&quot;name&quot;:&quot;Footer&quot;,&quot;value&quot;:true}" await-children=""><footer><div class="radius-for-skewed  bg-shorebirdBg1 pt-10 lg:pb-12 lg:pt-20 "><div class="container mx-auto w-4/5 px-4 md:w-11/12 lg:w-10/12 xl:w-4/5 2xl:w-2/3"><div class="flex flex-wrap"><div class="mb-16 w-full lg:mb-0 lg:w-1/3"><div class="flex grow basis-0 items-center justify-center lg:justify-start"><div class="mr-2 text-6xl text-white"><svg width="32" height="27" viewBox="0 0 32 27" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.14266 7.36943C6.46801 1.61099 12.2836 0.0571273 15.0257 0L13.5975 1.8852C16.3396 1.94233 18.2248 4.7987 19.3102 6.79815C20.11 8.74048 25.0229 12.7965 27.0224 13.5963C29.0219 14.3961 30.7357 13.2535 31.4783 13.025C32.221 12.7965 31.9354 13.2535 31.9925 13.5963C32.0496 13.9391 31.0213 15.8243 29.6503 17.7095C28.2792 19.5947 24.6802 21.4227 23.5376 21.9369C22.3951 22.451 20.0529 22.8509 16.7395 22.7367C13.4261 22.6224 10.3412 20.7372 8.79881 19.5375C7.25637 18.3379 3.48596 14.5675 5.14266 7.36943Z" fill="url(#paint0_radial_532_20)"></path><path d="M15.4808 7.31245C16.7604 5.89569 18.5656 6.37937 19.3083 6.7983C19.632 7.12202 20.3823 7.91799 20.7936 8.51212C21.3078 9.25477 23.8214 11.0828 24.8497 11.5399C25.878 11.9969 26.9063 11.9398 27.4775 12.054C28.0488 12.1683 27.9917 12.3397 27.8774 12.8538C27.7632 13.3679 24.7354 15.0818 23.8214 15.5959C22.9074 16.1101 21.6506 16.9132 18.9084 16.5099C16.9661 16.2243 14.681 13.5965 14.1097 12.3397C13.5384 11.0828 13.8812 9.0834 15.4808 7.31245Z" fill="url(#paint1_linear_532_20)"></path><path d="M0 9.71136L5.14146 7.42627C5.00435 7.92899 4.93199 8.54977 4.91295 8.79733L0 9.71136Z" fill="#897F76"></path><circle cx="4.57031" cy="8.05468" r="0.114255" fill="#070707"></circle><ellipse cx="9.02535" cy="7.42598" rx="1.48531" ry="1.77095" fill="black"></ellipse><circle cx="9.02538" cy="6.68358" r="0.457019" fill="white"></circle><path d="M12.7978 25.2502H15.5971L16.8539 22.8508L17.9393 22.7937L16.7968 25.2502H17.9964C18.2821 25.2502 18.3963 25.5929 18.3963 25.8214C18.3963 26.0043 18.0916 26.2023 17.9393 26.2785H12.7978C12.5693 26.2785 12.5693 25.8786 12.5693 25.7072C12.5693 25.5701 12.7217 25.3454 12.7978 25.2502Z" fill="#AA937E"></path><path d="M14.7402 25.3071H17.5395L18.7963 22.9077L19.8817 22.8506L18.7391 25.3071H19.9388C20.2245 25.3071 20.3387 25.6498 20.3387 25.8783C20.3387 26.0611 20.034 26.2592 19.8817 26.3354H14.7402C14.5117 26.3354 14.5117 25.9355 14.5117 25.7641C14.5117 25.627 14.6641 25.4023 14.7402 25.3071Z" fill="#B19A84"></path><defs><radialGradient id="paint0_radial_532_20" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(21.5759 7.60491) rotate(131.66) scale(18.2956 32.4674)"><stop offset="0.0263478" stop-color="#897F75"></stop><stop offset="0.538541" stop-color="#DEDAD4"></stop><stop offset="0.86124" stop-color="#F2F4F3"></stop></radialGradient><linearGradient id="paint1_linear_532_20" x1="21.8791" y1="9.65467" x2="17.0804" y2="15.3674" gradientUnits="userSpaceOnUse"><stop stop-color="#AE9883"></stop><stop offset="1" stop-color="#A9927D"></stop></linearGradient></defs></svg></div><div class="font-[&#x27;Inter&#x27;] text-xl font-bold text-white">Shorebird</div></div><p class="mx-auto mb-10 mt-4 text-center leading-loose text-gray-400 sm:w-[22rem] lg:mx-0 lg:w-[20rem] lg:text-left xl:w-[24rem]">We build products to help businesses be successful with Flutter.</p><div class="mx-auto w-36 lg:mx-0"><a class="shorebird-border-gray mr-2 inline-block h-10 w-10 rounded-xl bg-shorebirdBg2 p-2 hover:bg-gray-700" target="_blank" aria-label="discord" href="https://discord.gg/shorebird"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 fill-white" viewBox="20 0 640 512"><path d="M524.531,69.836a1.5,1.5,0,0,0-.764-.7A485.065,485.065,0,0,0,404.081,32.03a1.816,1.816,0,0,0-1.923.91,337.461,337.461,0,0,0-14.9,30.6,447.848,447.848,0,0,0-134.426,0,309.541,309.541,0,0,0-15.135-30.6,1.89,1.89,0,0,0-1.924-.91A483.689,483.689,0,0,0,116.085,69.137a1.712,1.712,0,0,0-.788.676C39.068,183.651,18.186,294.69,28.43,404.354a2.016,2.016,0,0,0,.765,1.375A487.666,487.666,0,0,0,176.02,479.918a1.9,1.9,0,0,0,2.063-.676A348.2,348.2,0,0,0,208.12,430.4a1.86,1.86,0,0,0-1.019-2.588,321.173,321.173,0,0,1-45.868-21.853,1.885,1.885,0,0,1-.185-3.126c3.082-2.309,6.166-4.711,9.109-7.137a1.819,1.819,0,0,1,1.9-.256c96.229,43.917,200.41,43.917,295.5,0a1.812,1.812,0,0,1,1.924.233c2.944,2.426,6.027,4.851,9.132,7.16a1.884,1.884,0,0,1-.162,3.126,301.407,301.407,0,0,1-45.89,21.83,1.875,1.875,0,0,0-1,2.611,391.055,391.055,0,0,0,30.014,48.815,1.864,1.864,0,0,0,2.063.7A486.048,486.048,0,0,0,610.7,405.729a1.882,1.882,0,0,0,.765-1.352C623.729,277.594,590.933,167.465,524.531,69.836ZM222.491,337.58c-28.972,0-52.844-26.587-52.844-59.239S193.056,219.1,222.491,219.1c29.665,0,53.306,26.82,52.843,59.239C275.334,310.993,251.924,337.58,222.491,337.58Zm195.38,0c-28.971,0-52.843-26.587-52.843-59.239S388.437,219.1,417.871,219.1c29.667,0,53.307,26.82,52.844,59.239C470.715,310.993,447.538,337.58,417.871,337.58Z"></path></svg></a><a class="shorebird-border-gray mr-2 inline-block h-10 w-10 rounded-xl bg-shorebirdBg2 p-2 hover:bg-gray-700" target="_blank" aria-label="twitter" href="https://twitter.com/shorebirddev"><svg xmlns="http://www.w3.org/2000/svg" viewBox="10 0 512 512" class="h-6 w-6 fill-white"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a><a class="shorebird-border-gray inline-block h-10 w-10 rounded-xl bg-shorebirdBg2 p-2 hover:bg-gray-700" target="_blank" aria-label="github" href="https://github.com/shorebirdtech/shorebird"><svg xmlns="http://www.w3.org/2000/svg" viewBox="10 0 496 512" class="h-6 w-6 fill-white"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg></a></div></div><div class="hidden w-full flex-wrap justify-between lg:flex lg:w-2/3 lg:pl-16"><div class="mb-16 w-full md:mb-0 md:w-1/3 lg:w-auto"><h3 class="mb-6 text-2xl font-bold text-white">Develop</h3><ul><li class="mb-4"><a target="_blank" rel="noreferrer" class="text-gray-400 hover:text-gray-300" href="https://console.shorebird.dev" aria-label="console">Console</a></li><li class="mb-4"><a target="_blank" rel="noreferrer" class="text-gray-400 hover:text-gray-300" href="https://docs.shorebird.dev" aria-label="documentation">Documentation</a></li><li class="mb-4"><a class="text-gray-400 hover:text-gray-300" href="/blog" aria-label="blog">Blog</a></li></ul></div><div class="w-full md:w-1/3 lg:w-auto"><h3 class="mb-6 text-2xl font-bold text-white">Company</h3><ul><li class="mb-4"><a class="text-gray-400 hover:text-gray-300" href="mailto:contact@shorebird.dev" aria-label="contact us">Contact Us</a></li><li><a class="text-gray-400 hover:text-gray-300" href="/jobs" aria-label="jobs">Jobs</a></li></ul></div><div class="mb-16 w-full md:mb-0 md:w-1/3 lg:w-auto"><h3 class="mb-6 text-2xl font-bold text-white">Legal</h3><ul><li class="mb-4"><a class="text-gray-400 hover:text-gray-300" href="/terms" aria-label="terms of use">Terms &amp; Conditions</a></li><li><a class="text-gray-400 hover:text-gray-300" href="/privacy" aria-label="privacy policy">Privacy Policy</a></li></ul></div></div></div><p class="mt-16 hidden border-t border-[rgb(255,255,255,0.2)] pt-12 text-sm text-gray-400 lg:block lg:text-center">© <!-- -->2024<!-- -->, Code Town Inc.</p></div></div></footer><!--astro:end--></astro-island>  </body> </html>